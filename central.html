<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MAX - Central de Inteligência</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #020617; color: white; overflow: hidden; }
        #sidebar-central { width: 400px; background: #0f172a; border-right: 2px solid #1e293b; display: flex; flex-direction: column; z-index: 1000; }
        .header-central { padding: 25px; background: #1e293b; border-bottom: 2px solid #334155; }
        #lista-alertas { flex-grow: 1; overflow-y: auto; padding: 15px; background: #020617; display: flex; flex-direction: column; gap: 12px; }
        .card-alerta { background: #1e293b; border-left: 5px solid #ef4444; padding: 15px; border-radius: 6px; font-size: 0.9rem; animation: slideIn 0.3s ease; }
        #map-central { flex-grow: 1; height: 100%; }
        .numero-chamados { display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; background: #ef4444; border: 3px solid white; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; box-shadow: 0 0 15px rgba(255,0,0,0.5); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="sidebar-central">
        <div class="header-central">
            <h2 style="margin:0; color:#3b82f6; letter-spacing:1px;">CENTRAL MAX</h2>
            <span style="font-size:0.7rem; color:#10b981; font-weight:bold;">● MONITORAMENTO EM TEMPO REAL</span>
        </div>
        <div id="lista-alertas">
            <p id="msg-vazia" style="text-align:center; color:#475569; margin-top:30px;">Aguardando transmissões...</p>
        </div>
    </div>

    <div id="map-central"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script>
        var map = L.map('map-central', { zoomControl: false }).setView([-23.44, -46.52], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const ably = new Ably.Realtime('nIelyg.53cnCw:XImw8D79XEvpS3D-o-satgyzgvrpKtNfhrcLFyIuvgM'); 
        const canal = ably.channels.get('monitoramento');
        let focosDeCrise = [];

        canal.subscribe('emergencia', (mensagem) => {
            const dados = mensagem.data;
            const agora = new Date().toLocaleTimeString();
            
            // Som de Alerta Tático
            new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play();

            // Atualiza Painel Lateral
            const lista = document.getElementById('lista-alertas');
            if(document.getElementById('msg-vazia')) document.getElementById('msg-vazia').remove();
            
            const card = document.createElement('div');
            card.className = 'card-alerta';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <b style="color:#f87171">ALERTA DE EMERGÊNCIA</b>
                    <small style="color:#94a3b8">${agora}</small>
                </div>
                <div>${dados.msg}</div>
            `;
            lista.prepend(card);

            // Gerencia Alvos no Mapa
            if(dados.lat && dados.lng) {
                let foco = focosDeCrise.find(f => map.distance([f.lat, f.lng], [dados.lat, dados.lng]) < 50);

                if(foco) {
                    foco.contagem++;
                    foco.marker.setRadius(50 + (foco.contagem * 10));
                    foco.label.setIcon(L.divIcon({ 
                        className: '', 
                        html: `<div class="numero-chamados">${foco.contagem}</div>`, 
                        iconSize: [45, 45],
                        iconAnchor: [22, 22]
                    }));
                } else {
                    let novoFoco = { lat: dados.lat, lng: dados.lng, contagem: 1 };
                    novoFoco.marker = L.circle([dados.lat, dados.lng], { 
                        color: 'red', fillColor: '#ef4444', fillOpacity: 0.4, radius: 50 
                    }).addTo(map);
                    
                    novoFoco.label = L.marker([dados.lat, dados.lng], {
                        icon: L.divIcon({ 
                            className: '', 
                            html: `<div class="numero-chamados">1</div>`, 
                            iconSize: [45, 45],
                            iconAnchor: [22, 22]
                        })
                    }).addTo(map);
                    
                    focosDeCrise.push(novoFoco);
                }
                map.flyTo([dados.lat, dados.lng], 17);
            }
        });
    </script>
</body>
</html>